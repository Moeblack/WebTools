import{createApp as nt}from"https://unpkg.com/vue@3/dist/vue.esm-browser.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();const at="modulepreload",ot=function(t,e){return new URL(t,e).href},j={},X=function(e,i,r){let s=Promise.resolve();if(i&&i.length>0){const a=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),h=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=Promise.allSettled(i.map(c=>{if(c=ot(c,r),c in j)return;j[c]=!0;const l=c.endsWith(".css"),u=l?'[rel="stylesheet"]':"";if(!!r)for(let f=a.length-1;f>=0;f--){const m=a[f];if(m.href===c&&(!l||m.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const p=document.createElement("link");if(p.rel=l?"stylesheet":at,l||(p.as="script"),p.crossOrigin="",p.href=c,h&&p.setAttribute("nonce",h),document.head.appendChild(p),l)return new Promise((f,m)=>{p.addEventListener("load",f),p.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return s.then(a=>{for(const o of a||[])o.status==="rejected"&&n(o.reason);return e().catch(n)})},O=new Set;async function U(t,e,i={}){const r=Number(i.timeout??1e4),s=i.attrs??{};if(typeof e=="function")try{if(e())return}catch{}if(O.has(t)){await B(e,r);return}await new Promise((n,a)=>{const o=document.createElement("script");o.src=t,o.async=!0,Object.entries(s).forEach(([h,c])=>{try{o.setAttribute(h,c)}catch{}}),o.onload=()=>{O.add(t),n()},o.onerror=h=>{a(new Error(`脚本加载失败: ${t}`))},document.head.appendChild(o)}),await B(e,r)}function B(t,e=8e3){return new Promise((i,r)=>{const s=Date.now();function n(){try{if(typeof t=="function"&&t()){i();return}}catch{}if(Date.now()-s>e){r(new Error("等待全局对象就绪超时"));return}setTimeout(n,200)}n()})}const ht=/<[^>]*>/g,ct=/{[^}]*}/g,lt=/\\[Nn]/g,W=/^\s*(?:\d{2}:){1,2}\d{2}[,.]\d{2,3}\s*-->\s*(?:\d{2}:){1,2}\d{2}[,.]\d{2,3}.*$/gm,Y=/^\s*\d+\s*$/gm,Z=/^\s*(NOTE|STYLE|REGION)[^\n]*[\s\S]*?(?=\n{2,}|\s*$)/gim,K=/^\s*\[[a-z]{2,}:[^\]]*]\s*$/gim,Q=/\[(?:\d{1,2}:){1,2}\d{2}(?:[.,]\d{2,3})?]/gi;function v(t){return t.replace(/\uFEFF/g,"").replace(/\r\n?/g,`
`)}function $(t){return t.replace(ht,"")}function M(t){return t?t.split(`
`).map(e=>e.trim()).filter(Boolean).join(`
`).replace(/\n{3,}/g,`

`).trim():""}function ut(t){if(!t)return"";const i=v(t).replace(Y,"").replace(W,"").replace(Z,"").replace(K,"").replace(Q,"");return M($(i))}function pt(t){return t?v(t).split(/\n{2,}/).map(s=>{const n=s.replace(Y,"").replace(W,"");return M($(n))}).filter(Boolean).join(`

`):""}function ft(t){return t?v(t).replace(/^WEBVTT[^\n]*\n?/,"").replace(Z,"").split(/\n{2,}/).map(n=>{const a=n.replace(W,"");return M($(a))}).filter(Boolean).join(`

`):""}function dt(t){if(!t)return"";const e=v(t);return M(e.replace(K,"").split(`
`).map(i=>i.replace(Q,"").trim()).filter(Boolean).join(`
`))}function mt(t){if(!t)return"";const e=/^Dialogue:\s*[^,]*,[^,]*,[^,]*,[^,]*,[^,]*,[^,]*,[^,]*,[^,]*,[^,]*,([\s\S]*)/i,i=v(t).split(`
`).map(r=>{const s=r.match(e);return!s||!s[1]?null:s[1].replace(ct,"").replace(lt,`
`)}).filter(Boolean);return M(i.join(`
`))}function tt(t){if(!t)return"unknown";const e=v(t);return/^WEBVTT(?:\s|$)/i.test(e)?"vtt":/^\s*\d+\s*\n\s*(?:\d{2}:){1,2}\d{2}[,.]\d{2,3}\s*-->/m.test(e)?"srt":/^\s*Dialogue:/im.test(e)?"ass":/\[(?:\d{1,2}:){1,2}\d{2}(?:[.,]\d{2,3})?]/.test(e)?"lrc":"unknown"}function et(t,e){switch(e){case"vtt":return ft(t);case"srt":return pt(t);case"lrc":return dt(t);case"ass":return mt(t);default:return ut(t)}}function gt(t){const e=tt(t);return{format:e,output:et(t,e)}}let T=null;async function wt(){return T&&typeof T=="function"?!0:(await U("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",()=>{try{return!!window.JSZip}catch{return!1}},{timeout:12e3,attrs:{crossorigin:"anonymous"}}),T=window.JSZip,!!T)}function St(t){return new Promise(e=>{const i=t.name.split(".").pop().toLowerCase();if(!["srt","lrc","ass","ssa","vtt"].includes(i)){e({originalName:t.name,error:"不支持的文件类型"});return}const r=new FileReader;r.onload=s=>{try{const n=String(s.target.result||""),a=tt(n),o=a!=="unknown"?a:i==="vtt"?"vtt":i.startsWith("ss")?"ass":i,h=et(n,o);if(!h){e({originalName:t.name,error:"未识别到有效的字幕文本",format:o});return}e({originalName:t.name,newName:t.name.replace(/\.[^/.]+$/,"")+"_cleaned.txt",content:h,format:o})}catch{e({originalName:t.name,error:"处理失败，请稍后重试"})}},r.onerror=()=>e({originalName:t.name,error:"文件读取失败"}),r.readAsText(t,"UTF-8")})}async function yt(t){if(!Array.isArray(t)||!t.length)throw new Error("没有可压缩的结果");if(!await wt())throw new Error("压缩库未就绪");const i=new T;return t.forEach((r,s)=>{const n=(r==null?void 0:r.newName)||`result-${s+1}.txt`;i.file(n,(r==null?void 0:r.content)??"")}),i.generateAsync({type:"blob"})}function vt(t,e,i){if(!t)return"";let r=t.split(/\r?\n/);return e&&(r=r.map(s=>s.replace(/^[#*>\-`]+\s*/,"").replace(/(\*\*|__)(.*?)\1/g,"$2").replace(/(\*|_)(.*?)\1/g,"$2").replace(/`([^`]+)`/g,"$1").replace(/!\[[^\]]*\]\([^)]+\)/g,"").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1"))),i?r.filter(s=>s.trim()!=="").join(`
`):r.join(`
`)}function bt(t,e){if(!t)return"";const i=String(e??"").replace(/\\n/g,`
`).replace(/\\t/g,"	");return t.split(/\r?\n/).filter(n=>n.trim()!=="").join(i)}function Gt(t,e="​"){if(!t)return"";const i=e!=null&&e.length>0?String(e):"​";return Array.from(t).join(i)}function Ft(t){if(!t)return{hanzi:0,words:0,punctuation:0,totalChars:0};const e=/[a-zA-Z0-9_']+/g,i=/[\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff]/g,r=(t.match(e)||[]).length;let s=t.replace(e,"");const n=(s.match(i)||[]).length;s=s.replace(i,"").replace(/\s/g,"");const a=s.length;return{hanzi:n,words:r,punctuation:a,totalChars:t.length}}function it(){return Math.floor(Date.now()/1e3)}function Pt({year:t,month:e,day:i,hour:r=0,minute:s=0,second:n=0}){const a=Number(t),o=Number(e),h=Number(i);if(!a||!o||!h)return null;const c=Number.isFinite(Number(r))?Number(r):0,l=Number.isFinite(Number(s))?Number(s):0,u=Number.isFinite(Number(n))?Number(n):0,d=new Date(a,o-1,h,c,l,u);return Number.isNaN(d.getTime())?null:Math.floor(d.getTime()/1e3)}function D(t){const e=Number(t);if(!Number.isFinite(e)||e<=0)return null;const i=new Date(e*1e3);return Number.isNaN(i.getTime())?null:{year:i.getFullYear(),month:i.getMonth()+1,day:i.getDate(),hour:i.getHours(),minute:i.getMinutes(),second:i.getSeconds()}}function F(t){return String(t).padStart(2,"0")}function N(t){return t?`${t.year}-${F(t.month)}-${F(t.day)} ${F(t.hour)}:${F(t.minute)}:${F(t.second)}`:""}function Tt(t,e,i,r){const s=Number(t)||0,n=Number(e)||0,a=Number(i)||0,o=Number(r)||0;return s*86400+n*3600+a*60+o}function _(t){let e=Number(t)||0;e<0&&(e=0);const i=Math.floor(e/86400);let r=e%86400;const s=Math.floor(r/3600);r%=3600;const n=Math.floor(r/60),a=r%60;return{days:i,hours:s,minutes:n,seconds:a}}function Ct(t){try{return btoa(unescape(encodeURIComponent(t??"")))}catch{return"编码失败：无效的输入字符。"}}function xt(t){try{return decodeURIComponent(escape(atob(t??"")))}catch{return"解码失败：无效的 Base64 字符串。"}}function It(t){return new Uint8Array(new TextEncoder().encode(t))}function Mt(t){try{return new TextDecoder("utf-8",{fatal:!0}).decode(t)}catch{throw new Error("UTF-8 解码失败：字节序列无效")}}function Et(t){const e=new Uint8Array(t.length);for(let i=0;i<t.length;i++){const r=t.charCodeAt(i);if(r>255)throw new Error("Latin-1 编码失败：存在超出 0xFF 的字符");e[i]=r&255}return e}function kt(t){let e="";for(let i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return e}function Ut(t,e="lower"){const i=[],r=s=>s.toString(16).padStart(2,"0");for(let s=0;s<t.length;s++){const n=r(t[s]);i.push("\\x"+(e==="upper"?n.toUpperCase():n))}return i.join("")}function Rt(t){return"b'"+t.replace(/'/g,"\\'")+"'"}function Nt(t){let e=String(t||"").trim();(e.startsWith("b'")||e.startsWith("B'"))&&e.endsWith("'")||(e.startsWith('b"')||e.startsWith('B"'))&&e.endsWith('"')?e=e.slice(2,-1):(e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"'))&&(e=e.slice(1,-1));const i=[];for(let r=0;r<e.length;r++){if(e[r]!=="\\"){const a=e.charCodeAt(r);i.push(a&255);continue}if(r++,r>=e.length)throw new Error("转义序列不完整：末尾出现单独的反斜杠");const n=e[r];switch(n){case"n":i.push(10);break;case"r":i.push(13);break;case"t":i.push(9);break;case"\\":i.push(92);break;case"'":i.push(39);break;case'"':i.push(34);break;case"0":i.push(0);break;case"x":{if(r+2>=e.length)throw new Error("十六进制转义不完整：\\x 后需两位十六进制");const a=e[r+1],o=e[r+2],h=a+o;if(!/^[0-9a-fA-F]{2}$/.test(h))throw new Error("无效的十六进制转义：\\x"+h);i.push(parseInt(h,16)),r+=2;break}default:i.push(n.charCodeAt(0));break}}return new Uint8Array(i)}function Dt(t){if(!t)return"text";const e=String(t).trim(),i=(e.startsWith("b'")||e.startsWith("B'"))&&e.endsWith("'")||(e.startsWith('b"')||e.startsWith('B"'))&&e.endsWith('"'),r=/\\x[0-9a-fA-F]{2}/.test(e),s=e.replace(/\s+/g,""),n=/^\\x[0-9a-fA-F]{2}(\\x[0-9a-fA-F]{2})+$/i.test(s);return i||r||n?"bytes":"text"}function Lt({input:t="",sourceMode:e="text",encoding:i="utf8",outputMode:r="python",hexCase:s="lower"}){const n=e==="bytes"?"bytes":"text",a=i==="latin1"?"latin1":"utf8",o=r==="plain"?"plain":"python";try{if(n==="text"){const l=a==="utf8"?It(t):Et(t),u=Ut(l,s);return{result:o==="python"?Rt(u):u,error:""}}const h=Nt(t);return{result:a==="utf8"?Mt(h):kt(h),error:""}}catch(h){return{result:"",error:h.message||String(h)}}}const Wt="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js",$t=()=>{try{const t=window||{};if(t.OpenCC&&typeof t.OpenCC.Converter=="function"||t.opencc&&typeof t.opencc.Converter=="function"||t.OpenCCJS&&typeof t.OpenCCJS.Converter=="function"||t.OpenCC&&t.OpenCC.default&&typeof t.OpenCC.default.Converter=="function")return!0}catch{}return!1};function At(){const t=window||{};return t.OpenCC&&typeof t.OpenCC.Converter=="function"?t.OpenCC:t.opencc&&typeof t.opencc.Converter=="function"?t.opencc:t.OpenCCJS&&typeof t.OpenCCJS.Converter=="function"?t.OpenCCJS:t.OpenCC&&t.OpenCC.default&&typeof t.OpenCC.default.Converter=="function"?t.OpenCC.default:null}let x=null,I=null;async function rt(){if(x&&I)return!0;await U(Wt,$t,{timeout:12e3,attrs:{crossorigin:"anonymous"}});const t=At();if(!t)return!1;try{return x||(x=t.Converter({from:"tw",to:"cn"})),I||(I=t.Converter({from:"cn",to:"tw"})),!0}catch(e){return console.warn("创建 OpenCC 转换器失败：",e),!1}}function jt(t){return String(t??"").replace(/『/g,"【").replace(/』/g,"】")}async function Ot(t,e){if(!await rt())throw new Error("简繁词库仍在加载，请稍后重试");return t==="t2s"?x?x(e??""):e??"":I?I(e??""):e??""}const Bt="https://unpkg.com/gifenc@1.0.3/dist/gifenc.umd.js";let S=null;async function _t(){if(S)return!0;try{return S=await X(()=>import("https://unpkg.com/gifenc@1.0.3/dist/gifenc.esm.js"),[],import.meta.url),!0}catch(t){console.warn("ESM 导入失败，尝试 UMD 方式",t)}try{return await U(Bt,()=>!!window.gifenc,{timeout:15e3}),S=window.gifenc,!!S}catch(t){return console.error("gifenc 加载失败",t),!1}}function st(t){return{data:t.getContext("2d").getImageData(0,0,t.width,t.height).data,width:t.width,height:t.height}}function Ht(t,e=256,i={}){if(!S)throw new Error("gifenc 模块未加载，请先调用 ensureGifenc()");const{quantize:r}=S,s=i.format||"rgb565";return r(t,Math.min(256,Math.max(2,e)),{format:s,oneBitAlpha:!0})}function zt(t,e,i="rgb565"){if(!S)throw new Error("gifenc 模块未加载");const{applyPalette:r}=S;return r(t,e,i)}function Jt(t,e){const i=new Uint8ClampedArray(t.length*4);for(let r=0;r<t.length;r++){const s=t[r],n=e[s]||[0,0,0],a=r*4;i[a]=n[0],i[a+1]=n[1],i[a+2]=n[2],i[a+3]=255}return i}function Vt(t,e,i="rgb565"){const{data:r,width:s,height:n}=st(t),a=zt(r,e,i),o=Jt(a,e),h=document.createElement("canvas");h.width=s,h.height=n;const c=h.getContext("2d"),l=new ImageData(o,s,n);return c.putImageData(l,0,0),h}function H(t){return t.map((e,i)=>{const[r,s,n]=e;return{hex:`#${((1<<24)+(r<<16)+(s<<8)+n).toString(16).slice(1)}`,rgb:[r,s,n],index:i}})}function z(t){return[...t].sort((e,i)=>{const r=.299*e[0]+.587*e[1]+.114*e[2],s=.299*i[0]+.587*i[1]+.114*i[2];return r-s})}function J(t){return[...t].sort((e,i)=>{const r=V(e[0],e[1],e[2]),s=V(i[0],i[1],i[2]);return r-s})}function V(t,e,i){t/=255,e/=255,i/=255;const r=Math.max(t,e,i),s=Math.min(t,e,i),n=r-s;if(n===0)return 0;let a;switch(r){case t:a=((e-i)/n+(e<i?6:0))/6;break;case e:a=((i-t)/n+2)/6;break;case i:a=((t-e)/n+4)/6;break}return a*360}async function qt(t){if(t==null)return!1;const e=String(t);try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")return await navigator.clipboard.writeText(e),!0}catch{}try{const i=document.createElement("textarea");i.value=e,i.setAttribute("readonly",""),i.style.position="fixed",i.style.top="-9999px",document.body.appendChild(i),i.focus(),i.select();const r=document.execCommand("copy");return document.body.removeChild(i),!!r}catch{return!1}}const Xt=[{key:"subtitle",label:"字幕工具"},{key:"cleanup",label:"文本清理"},{key:"joiner",label:"文本拼接"},{key:"injector",label:"文本加料"},{key:"counter",label:"字数统计"},{key:"timestamp",label:"时间戳转换"},{key:"duration",label:"时间段转换"},{key:"base64",label:"Base64"},{key:"escape",label:"文本转义"},{key:"converter",label:"简繁转换"},{key:"palette",label:"调色盘"},{key:"gifSprite",label:"GIF 转精灵图"},{key:"spriteGif",label:"精灵图转GIF"}],Yt=typeof location<"u"&&location.protocol==="file:",Zt="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js",q=()=>typeof window<"u"&&typeof window.GIF=="function";let k=null;async function Kt(){if(!Yt&&"serviceWorker"in navigator)try{const t=await navigator.serviceWorker.register("./sw.js",{scope:"./"});t&&t.addEventListener&&t.addEventListener("updatefound",()=>{const e=t.installing;e&&e.addEventListener("statechange",()=>{})})}catch(t){console.warn("ServiceWorker 注册失败：",t)}}function C(t,e){const i=URL.createObjectURL(e),r=document.createElement("a");r.href=i,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}function P(t,e){const i=new Blob([e||""],{type:"text/plain;charset=utf-8"});C(t,i)}const L=it(),y=D(L)||{year:"",month:"",day:"",hour:"",minute:"",second:""},Qt=nt({data(){return{tabs:Xt,activeTab:"subtitle",toast:{visible:!1,message:"",type:"info"},toastTimer:null,subtitle:{pasteInput:"",pasteOutput:"",pasteFormat:"",batchResults:[],status:"请上传文件或文件夹...",isProcessing:!1,downloadInProgress:!1,fileInputKey:Date.now()},cleanup:{input:"",output:"",removeMarkdown:!0,removeEmptyLines:!0},joiner:{input:"",separator:"\\n",displayOutput:"",lastResult:""},injector:{input:"",string:"",output:""},counter:{input:""},timestamp:{year:y.year,month:y.month,day:y.day,hour:y.hour,minute:y.minute,second:y.second,fromDate:"",fromTsInput:String(L),fromTsOutput:N(y),current:L},timestampTicker:null,duration:{days:"0",hours:"0",minutes:"0",seconds:"0",totalSeconds:"0",outputs:{days:"0",hours:"0",minutes:"0",seconds:"0"}},base64:{input:"",output:""},escape:{input:"",output:"",sourceMode:"text",encoding:"utf8",outputMode:"python",hexCase:"lower",error:""},converter:{input:"",output:"",quotes:!0,converting:!1,ready:!1,prefetching:!1},palette:{isDragging:!1,isProcessing:!1,status:"请上传 PNG / JPG 图片",imageName:"",imageUrl:"",originalDataUrl:"",imageWidth:0,imageHeight:0,maxColors:256,format:"rgb565",sortMode:"none",colors:[],rawPalette:[],quantizedUrl:"",quantizedCanvas:null,libReady:!1,libLoading:!1},spriteGif:{columns:4,rows:2,fps:8,padding:0,imageName:"",imageUrl:"",originalDataUrl:"",imageWidth:0,imageHeight:0,frameWidth:0,frameHeight:0,totalFrameCount:0,frameCount:0,frames:[],framePreviews:[],allFrames:[],allFramePreviews:[],discardedFrames:[],previewFrameIndex:0,previewPlaying:!0,gridPreviewUrl:"",effectivePadding:0,isDragging:!1,isGenerating:!1,status:"请选择 PNG / JPG 格式的精灵图",editPanelOpen:!1,workerUrl:"",workerBlobUrl:"",gifLibReady:!1,gifLibLoading:!1,edit:{cropX:0,cropY:0,cropWidth:0,cropHeight:0,rotation:0,removeBg:!1,bgColor:"#ffffff",bgTolerance:30}},gifSprite:{isDragging:!1,isProcessing:!1,status:"请上传 GIF 动画",fileName:"",gifWidth:0,gifHeight:0,totalFrames:0,frames:[],activeFrames:[],activeCellPositions:[],discardedFrames:[],columns:8,padding:0,backgroundMode:"transparent",backgroundColor:"#000000",spriteUrl:"",spritePreviewUrl:"",spriteWidth:0,spriteHeight:0,previewFrameIndex:0,previewPlaying:!0,estimatedText:"--",currentColumns:0,currentRows:0,decoderModule:null},spritePreviewTimer:null,gifSpritePreviewTimer:null}},computed:{counterStats(){return Ft(this.counter.input)},subtitleHasResults(){return this.subtitle.batchResults.some(t=>!t.error)}},methods:{async copyValue(t){if(t==null||t===""){this.showToast("没有可复制的内容","warning");return}const e=await qt(t);this.showToast(e?"已复制到剪贴板":"复制失败，请允许剪贴板权限",e?"success":"error")},showToast(t,e="info"){this.toast.message=t,this.toast.type=e,this.toast.visible=!0,this.toastTimer&&clearTimeout(this.toastTimer),this.toastTimer=setTimeout(()=>{this.toast.visible=!1},2400)},processSubtitlePaste(){if(!this.subtitle.pasteInput){this.subtitle.pasteOutput="",this.subtitle.pasteFormat="";return}const{output:t,format:e}=gt(this.subtitle.pasteInput);this.subtitle.pasteOutput=t,this.subtitle.pasteFormat=e},async handleSubtitleFiles(t){const e=Array.from(t||[]);if(!e.length)return;this.subtitle.isProcessing=!0,this.subtitle.status=`正在处理 ${e.length} 个文件...`,this.subtitle.batchResults=[],this.subtitle.downloadInProgress=!1;const i=[];for(let n=0;n<e.length;n+=1){const a=e[n];this.subtitle.status=`正在处理 ${n+1} / ${e.length}：${a.name}`;try{const o=await St(a);i.push(o)}catch(o){i.push({originalName:a.name,error:(o==null?void 0:o.message)||"处理失败"})}}this.subtitle.batchResults=i;const r=i.filter(n=>!n.error).length,s=i.length-r;this.subtitle.status=`已处理 ${r} / ${e.length} 个文件`,s>0&&this.showToast(`${s} 个文件处理失败`,"warning"),this.subtitle.isProcessing=!1,this.subtitle.fileInputKey=Date.now()},downloadSubtitleItem(t){t.error||P(t.newName,t.content||"")},async downloadSubtitleZip(){const t=this.subtitle.batchResults.filter(e=>!e.error);if(!t.length){this.showToast("暂无可打包内容","warning");return}this.subtitle.downloadInProgress=!0;try{const e=await yt(t);C("subtitle_results.zip",e),this.showToast("ZIP 已生成","success")}catch(e){this.showToast(e.message||"打包失败","error")}finally{this.subtitle.downloadInProgress=!1}},clearSubtitleBatch(){this.subtitle.batchResults=[],this.subtitle.status="请上传文件或文件夹...",this.subtitle.fileInputKey=Date.now()},runCleanup(){this.cleanup.output=vt(this.cleanup.input,this.cleanup.removeMarkdown,this.cleanup.removeEmptyLines)},copyCleanup(){this.copyValue(this.cleanup.output)},downloadCleanup(){this.cleanup.output&&P("cleaned_text.txt",this.cleanup.output)},runJoiner(){this.joiner.lastResult=bt(this.joiner.input,this.joiner.separator),this.joiner.displayOutput=(this.joiner.lastResult||"").replace(/\n/g,"\\n").replace(/\t/g,"\\t")},copyJoiner(){this.copyValue(this.joiner.lastResult)},downloadJoiner(){this.joiner.lastResult&&P("joined_text.txt",this.joiner.lastResult)},updateInjected(){this.injector.output=Gt(this.injector.input,this.injector.string||"​")},useZeroWidth(){this.injector.string="​",this.updateInjected()},copyInjector(){this.copyValue(this.injector.output)},downloadInjector(){this.injector.output&&P("injected_text.txt",this.injector.output)},updateTimestampFromDate(){const t=Pt({year:this.timestamp.year,month:this.timestamp.month,day:this.timestamp.day,hour:this.timestamp.hour,minute:this.timestamp.minute,second:this.timestamp.second});if(t==null){this.timestamp.fromDate="";return}this.timestamp.fromDate=String(t);const e=D(t);this.timestamp.fromTsInput=String(t),this.timestamp.fromTsOutput=N(e)},updateDateFromTimestamp(){const t=Number(this.timestamp.fromTsInput),e=D(t);if(!e){this.timestamp.fromTsOutput="";return}this.timestamp.year=e.year,this.timestamp.month=e.month,this.timestamp.day=e.day,this.timestamp.hour=e.hour,this.timestamp.minute=e.minute,this.timestamp.second=e.second,this.timestamp.fromTsOutput=N(e),this.timestamp.fromDate=String(t)},copyTimestamp(t){this.copyValue(t)},startTimestampTicker(){this.timestampTicker&&clearInterval(this.timestampTicker),this.timestampTicker=setInterval(()=>{this.timestamp.current=it()},1e3)},updateSecondsFromDuration(){const t=Tt(this.duration.days,this.duration.hours,this.duration.minutes,this.duration.seconds);this.duration.totalSeconds=String(t);const e=_(t);this.duration.outputs={days:String(e.days),hours:String(e.hours),minutes:String(e.minutes),seconds:String(e.seconds)}},updateDurationFromSeconds(){const t=_(this.duration.totalSeconds);this.duration.days=String(t.days),this.duration.hours=String(t.hours),this.duration.minutes=String(t.minutes),this.duration.seconds=String(t.seconds),this.duration.outputs={days:String(t.days),hours:String(t.hours),minutes:String(t.minutes),seconds:String(t.seconds)}},applyQuickDuration(t,e){this.duration.days=String(t),this.duration.hours=String(e),this.duration.minutes="0",this.duration.seconds="0",this.updateSecondsFromDuration()},encodeBase64(){this.base64.output=Ct(this.base64.input)},decodeBase64(){this.base64.output=xt(this.base64.input)},copyBase64(){this.copyValue(this.base64.output)},autoDetectEscapeMode(){this.escape.sourceMode=Dt(this.escape.input)},runEscapeConversion(){const{result:t,error:e}=Lt({input:this.escape.input,sourceMode:this.escape.sourceMode,encoding:this.escape.encoding,outputMode:this.escape.outputMode,hexCase:this.escape.hexCase});this.escape.output=t,this.escape.error=e},copyEscape(){this.copyValue(this.escape.output)},downloadEscape(){this.escape.output&&P("escaped_text.txt",this.escape.output)},async prefetchConverters(){if(!(this.converter.prefetching||this.converter.ready)){this.converter.prefetching=!0;try{const t=await rt();this.converter.ready=t}catch{this.converter.ready=!1}finally{this.converter.prefetching=!1}}},async runConverter(t){if(!this.converter.input){this.converter.output="";return}this.converter.converting=!0;try{const e=await Ot(t,this.converter.input),i=this.converter.quotes?jt(e):e;this.converter.output=i,this.converter.ready=!0,this.showToast("转换完成","success")}catch(e){this.showToast(e.message||"转换失败，请稍后重试","error")}finally{this.converter.converting=!1}},copyConverter(){this.copyValue(this.converter.output)},triggerGifSpriteUpload(){var e;const t=(e=this.$refs)==null?void 0:e.gifSpriteFileInput;t&&t.click()},async handleGifSpriteFileSelect(t){var r,s;const e=Array.from(t||[]);if(!e.length)return;const i=e[0];if(!((r=i.type)!=null&&r.includes("gif"))){this.showToast("仅支持 GIF 动画","warning");return}try{await this.loadGifSpriteFile(i)}catch(n){this.showToast((n==null?void 0:n.message)||"GIF 解析失败","error")}finally{(s=this.$refs)!=null&&s.gifSpriteFileInput&&(this.$refs.gifSpriteFileInput.value="")}},handleGifSpriteDrop(t){var e,i;this.gifSprite.isDragging=!1,(i=(e=t.dataTransfer)==null?void 0:e.files)!=null&&i.length&&this.handleGifSpriteFileSelect(t.dataTransfer.files)},async loadGifSpriteFile(t){this.gifSprite.isProcessing=!0,this.gifSprite.status="正在解析 GIF...",this.stopGifSpritePreviewTimer();try{const e=await this.readFileAsArrayBuffer(t),{frames:i,width:r,height:s}=await this.decodeGifArrayBuffer(e);if(!i.length)throw new Error("未能在 GIF 中检测到有效帧");this.gifSprite.fileName=t.name,this.gifSprite.frames=i,this.gifSprite.gifWidth=r,this.gifSprite.gifHeight=s,this.gifSprite.totalFrames=i.length,this.gifSprite.discardedFrames=[],this.gifSprite.previewFrameIndex=0,this.gifSprite.previewPlaying=!0,this.gifSprite.status=`已载入 ${i.length} 帧 · 单帧 ${r} × ${s}`,this.refreshGifSpriteFrames(),this.showToast("GIF 解析完成","success")}finally{this.gifSprite.isProcessing=!1}},async decodeGifArrayBuffer(t){var f,m;const e=await this.ensureGifuctModule(),{parseGIF:i,decompressFrames:r}=e;if(!i||!r)throw new Error("GIF 解码器加载失败");const s=i(t),n=r(s,!0)||[],a=((f=s==null?void 0:s.lsd)==null?void 0:f.width)||0,o=((m=s==null?void 0:s.lsd)==null?void 0:m.height)||0;if(!a||!o)throw new Error("GIF 尺寸无效");const h=document.createElement("canvas");h.width=a,h.height=o;const c=h.getContext("2d");if(!c)throw new Error("画布初始化失败");c.clearRect(0,0,a,o);const l=document.createElement("canvas"),u=l.getContext("2d");if(!u)throw new Error("无法创建临时画布");const d=[];let p=null;return n.forEach((w,R)=>{const g=(w==null?void 0:w.dims)||{};if(!g.width||!g.height)return;w.disposalType===3&&(p=c.getImageData(0,0,a,o)),l.width=g.width,l.height=g.height;const b=u.createImageData(g.width,g.height),E=w.patch instanceof Uint8ClampedArray?w.patch:new Uint8ClampedArray(w.patch);b.data.set(E),u.putImageData(b,0,0),c.drawImage(l,g.left,g.top);const G=document.createElement("canvas");G.width=a,G.height=o;const A=G.getContext("2d");A&&(A.drawImage(h,0,0),d.push({canvas:G,previewUrl:G.toDataURL("image/png"),delay:Math.max(20,w.delay||80),sourceIndex:R}),w.disposalType===2?c.clearRect(g.left||0,g.top||0,g.width,g.height):w.disposalType===3&&p&&(c.putImageData(p,0,0),p=null))}),{frames:d,width:a,height:o}},async ensureGifuctModule(){if(this.gifSprite.decoderModule)return this.gifSprite.decoderModule;const t=await X(()=>import("https://esm.sh/gifuct-js@2.1.2"),[],import.meta.url);return this.gifSprite.decoderModule=t,t},refreshGifSpriteFrames(){const t=new Set(this.gifSprite.discardedFrames||[]),e=(this.gifSprite.frames||[]).filter(i=>!t.has(i.sourceIndex));if(this.gifSprite.activeFrames=e,e.length?this.gifSprite.previewFrameIndex>=e.length&&(this.gifSprite.previewFrameIndex=0):(this.gifSprite.previewFrameIndex=0,this.stopGifSpritePreviewTimer()),this.gifSprite.previewPlaying&&e.length&&this.startGifSpritePreviewTimer(),this.rebuildGifSpriteSheet(),this.gifSprite.totalFrames){const i=t.size,r=Math.max(0,this.gifSprite.totalFrames-i),s=`原 GIF：${this.gifSprite.gifWidth} × ${this.gifSprite.gifHeight} · 帧 ${this.gifSprite.totalFrames}`;this.gifSprite.status=i?`${s} · 可用 ${r}`:s}},rebuildGifSpriteSheet(){var u,d,p,f;const t=this.gifSprite.activeFrames||[];if(!t.length){this.gifSprite.spriteUrl="",this.gifSprite.spritePreviewUrl="",this.gifSprite.spriteWidth=0,this.gifSprite.spriteHeight=0,this.gifSprite.estimatedText="--",this.gifSprite.currentColumns=0,this.gifSprite.currentRows=0,this.gifSprite.activeCellPositions=[];return}const e=Math.max(1,Math.floor(Number(this.gifSprite.columns)||1)),i=Math.max(0,Math.floor(Number(this.gifSprite.padding)||0)),r=this.gifSprite.gifWidth||((d=(u=t[0])==null?void 0:u.canvas)==null?void 0:d.width)||0,s=this.gifSprite.gifHeight||((f=(p=t[0])==null?void 0:p.canvas)==null?void 0:f.height)||0,n=Math.max(1,Math.ceil(t.length/e)),a=e*r+i*Math.max(0,e-1),o=n*s+i*Math.max(0,n-1),h=document.createElement("canvas");h.width=a,h.height=o;const c=h.getContext("2d");if(!c)return;this.gifSprite.backgroundMode==="color"?(c.fillStyle=this.gifSprite.backgroundColor||"#000000",c.fillRect(0,0,a,o)):c.clearRect(0,0,a,o),c.imageSmoothingEnabled=!1;const l=[];t.forEach((m,w)=>{const R=w%e,g=Math.floor(w/e),b=R*(r+i),E=g*(s+i);c.drawImage(m.canvas,b,E),l.push({sourceIndex:m.sourceIndex,x:b,y:E,width:r,height:s})}),this.gifSprite.spriteUrl=h.toDataURL("image/png"),this.gifSprite.spritePreviewUrl=this.buildGifSpritePreview(h,l,e,r,s,i),this.gifSprite.spriteWidth=a,this.gifSprite.spriteHeight=o,this.gifSprite.estimatedText=`${a} × ${o}`,this.gifSprite.currentColumns=e,this.gifSprite.currentRows=n,this.gifSprite.activeCellPositions=l},buildGifSpritePreview(t,e,i,r,s,n){const a=document.createElement("canvas");a.width=t.width,a.height=t.height;const o=a.getContext("2d");if(!o)return"";o.drawImage(t,0,0);const h=Math.max(1,Math.ceil(e.length/i));return o.save(),o.strokeStyle="rgba(37,99,235,0.75)",o.lineWidth=1,o.setLineDash([6,4]),e.forEach(c=>{o.strokeRect(Math.round(c.x)+.5,Math.round(c.y)+.5,c.width,c.height)}),o.restore(),n>0&&(o.save(),o.fillStyle="rgba(251,191,36,0.18)",e.forEach((c,l)=>{const u=l%i,d=Math.floor(l/i),p=l+1;u!==i-1&&p<=e.length-1&&o.fillRect(c.x+c.width,c.y,n,c.height),d<h-1&&o.fillRect(c.x,c.y+c.height,c.width,n)}),o.restore()),a.toDataURL("image/png")},handleGifSpritePreviewClick(t){var l;if(!this.gifSprite.spritePreviewUrl)return;const e=(l=this.$refs)==null?void 0:l.gifSpritePreviewImage;if(!e)return;const i=e.getBoundingClientRect();if(!i.width||!i.height)return;const r=t.clientX-i.left,s=t.clientY-i.top;if(r<0||s<0)return;const n=(this.gifSprite.spriteWidth||i.width)/i.width,a=(this.gifSprite.spriteHeight||i.height)/i.height,o=r*n,h=s*a,c=this.gifSprite.activeCellPositions.find(u=>o>=u.x&&o<=u.x+u.width&&h>=u.y&&h<=u.y+u.height);c&&this.toggleGifSpriteFrame(c.sourceIndex)},toggleGifSpriteFrame(t){if(!Number.isInteger(t)||t<0)return;const e=new Set(this.gifSprite.discardedFrames||[]);e.has(t)?e.delete(t):e.add(t),this.gifSprite.discardedFrames=Array.from(e).sort((i,r)=>i-r),this.refreshGifSpriteFrames()},restoreGifSpriteFrame(t){Number.isInteger(t)&&this.gifSprite.discardedFrames.length&&(this.gifSprite.discardedFrames=this.gifSprite.discardedFrames.filter(e=>e!==t),this.refreshGifSpriteFrames())},restoreAllGifSpriteFrames(){this.gifSprite.discardedFrames.length&&(this.gifSprite.discardedFrames=[],this.refreshGifSpriteFrames())},startGifSpritePreviewTimer(){this.stopGifSpritePreviewTimer(),!(!this.gifSprite.previewPlaying||!this.gifSprite.activeFrames.length)&&this.scheduleGifSpritePreviewTick()},scheduleGifSpritePreviewTick(){if(!this.gifSprite.previewPlaying||!this.gifSprite.activeFrames.length)return;const t=this.gifSprite.activeFrames[this.gifSprite.previewFrameIndex],e=Math.max(30,(t==null?void 0:t.delay)||80);this.gifSpritePreviewTimer=setTimeout(()=>{!this.gifSprite.previewPlaying||!this.gifSprite.activeFrames.length||(this.gifSprite.previewFrameIndex=(this.gifSprite.previewFrameIndex+1)%this.gifSprite.activeFrames.length,this.scheduleGifSpritePreviewTick())},e)},stopGifSpritePreviewTimer(){this.gifSpritePreviewTimer&&(clearTimeout(this.gifSpritePreviewTimer),this.gifSpritePreviewTimer=null)},toggleGifSpritePreview(){this.gifSprite.activeFrames.length&&(this.gifSprite.previewPlaying=!this.gifSprite.previewPlaying,this.gifSprite.previewPlaying?this.startGifSpritePreviewTimer():this.stopGifSpritePreviewTimer())},async downloadGifSpriteSheet(){var t;if(!this.gifSprite.spriteUrl){this.showToast("请先生成精灵图","warning");return}try{const i=await(await fetch(this.gifSprite.spriteUrl)).blob(),r=(((t=this.gifSprite.fileName)==null?void 0:t.replace(/\\.[^.]+$/,""))||"gif_sprite")+"_sheet.png";C(r,i),this.showToast("精灵图已下载","success")}catch(e){this.showToast((e==null?void 0:e.message)||"下载失败","error")}},getGifDiscardPreview(t){const e=(this.gifSprite.frames||[]).find(i=>i.sourceIndex===t);return(e==null?void 0:e.previewUrl)||""},triggerSpriteFileSelect(){var e;const t=(e=this.$refs)==null?void 0:e.spriteFileInput;t&&t.click()},async handleSpriteFileSelect(t){var r,s;const e=Array.from(t||[]);if(!e.length)return;const i=e[0];if(!((r=i.type)!=null&&r.startsWith("image/"))){this.showToast("仅支持 PNG / JPG 图片","warning");return}try{await this.loadSpriteFile(i)}catch(n){this.showToast((n==null?void 0:n.message)||"图片加载失败","error")}finally{(s=this.$refs)!=null&&s.spriteFileInput&&(this.$refs.spriteFileInput.value="")}},handleSpriteDrop(t){var e,i;this.spriteGif.isDragging=!1,(i=(e=t.dataTransfer)==null?void 0:e.files)!=null&&i.length&&this.handleSpriteFileSelect(t.dataTransfer.files)},async loadSpriteFile(t){const e=await this.readFileAsDataUrl(t);this.spriteGif.imageName=t.name,this.spriteGif.originalDataUrl=e,this.spriteGif.imageUrl=e,await this.syncSpriteImageMeta(e)},readFileAsDataUrl(t){return new Promise((e,i)=>{const r=new FileReader;r.onload=()=>e(r.result),r.onerror=()=>i(new Error("读取文件失败")),r.readAsDataURL(t)})},readFileAsArrayBuffer(t){return new Promise((e,i)=>{const r=new FileReader;r.onload=()=>e(r.result),r.onerror=()=>i(new Error("读取文件失败")),r.readAsArrayBuffer(t)})},loadImageFromUrl(t){return new Promise((e,i)=>{if(!t){i(new Error("图片地址无效"));return}const r=new Image;r.onload=()=>e(r),r.onerror=()=>i(new Error("图片无法加载")),r.crossOrigin="anonymous",r.src=t})},async syncSpriteImageMeta(t){try{const e=await this.loadImageFromUrl(t);this.spriteGif.imageWidth=e.width,this.spriteGif.imageHeight=e.height,this.spriteGif.status=`原图尺寸：${e.width} × ${e.height}`,this.initializeSpriteEditBounds(e.width,e.height),await this.updateSpriteFrames()}catch(e){this.showToast((e==null?void 0:e.message)||"无法读取图片信息","error")}},initializeSpriteEditBounds(t,e){this.spriteGif.edit.cropX=0,this.spriteGif.edit.cropY=0,this.spriteGif.edit.cropWidth=t,this.spriteGif.edit.cropHeight=e,this.spriteGif.edit.rotation=0,this.spriteGif.edit.removeBg=!1},clampSpriteValue(t,e,i){return Math.min(Math.max(t,e),i)},computeSpriteGridMetrics(t,e,i,r,s){const n=Math.floor(t/i),a=Math.floor(e/r);if(n<=0||a<=0)throw new Error("请调整分割数以得到有效的帧尺寸");const o=Math.max(0,Number(s)||0),h=Math.min(Math.floor(n/2)-1,Math.floor(a/2)-1),c=Math.max(0,isNaN(h)?0:Math.min(o,Math.max(0,h))),l=Math.max(1,n-c*2),u=Math.max(1,a-c*2);return{cellWidth:n,cellHeight:a,effectivePadding:c,frameWidth:l,frameHeight:u}},refreshSpriteFrameUsage(){const t=new Set(this.spriteGif.discardedFrames||[]),e=[],i=[];(this.spriteGif.allFrames||[]).forEach((r,s)=>{var a;if(t.has(s))return;e.push(r);const n=(a=this.spriteGif.allFramePreviews)==null?void 0:a[s];n?i.push(n):i.push(r.toDataURL("image/png"))}),this.spriteGif.frames=e,this.spriteGif.framePreviews=i,this.spriteGif.frameCount=e.length,e.length?this.spriteGif.previewFrameIndex>=e.length&&(this.spriteGif.previewFrameIndex=0):(this.spriteGif.previewFrameIndex=0,this.stopSpritePreviewTimer()),this.spriteGif.previewPlaying&&e.length&&this.startSpritePreviewTimer(),this.updateSpriteFrameStatus()},updateSpriteFrameStatus(){var n;const t=this.spriteGif.totalFrameCount||0;if(!t)return;const e=this.spriteGif.frameWidth||0,i=this.spriteGif.frameHeight||0,r=((n=this.spriteGif.discardedFrames)==null?void 0:n.length)||0;let s=`总帧数 ${t} · 单帧 ${e} × ${i}`;r&&(s+=` · 已丢弃 ${r} · 可用 ${Math.max(0,t-r)}`),this.spriteGif.status=s},async updateSpriteFrames(){if(!this.spriteGif.imageUrl){this.spriteGif.frames=[],this.spriteGif.framePreviews=[],this.spriteGif.allFrames=[],this.spriteGif.allFramePreviews=[],this.spriteGif.frameCount=0,this.spriteGif.totalFrameCount=0,this.spriteGif.frameWidth=0,this.spriteGif.frameHeight=0,this.spriteGif.gridPreviewUrl="",this.spriteGif.previewFrameIndex=0,this.spriteGif.discardedFrames=[],this.spriteGif.effectivePadding=0,this.stopSpritePreviewTimer(),this.spriteGif.status="请选择 PNG / JPG 格式的精灵图";return}const t=Math.max(1,Math.floor(Number(this.spriteGif.columns)||1)),e=Math.max(1,Math.floor(Number(this.spriteGif.rows)||1));try{const i=await this.loadImageFromUrl(this.spriteGif.imageUrl),{cellWidth:r,cellHeight:s,effectivePadding:n,frameWidth:a,frameHeight:o}=this.computeSpriteGridMetrics(i.width,i.height,t,e,this.spriteGif.padding),h=[],c=[];for(let l=0;l<e;l+=1)for(let u=0;u<t;u+=1){const d=u*r+n,p=l*s+n,f=document.createElement("canvas");f.width=a,f.height=o;const m=f.getContext("2d");m.imageSmoothingEnabled=!1,m.clearRect(0,0,a,o),m.drawImage(i,d,p,a,o,0,0,a,o),h.push(f),c.push(f.toDataURL("image/png"))}this.spriteGif.allFrames=h,this.spriteGif.allFramePreviews=c,this.spriteGif.totalFrameCount=h.length,this.spriteGif.frameWidth=a,this.spriteGif.frameHeight=o,this.spriteGif.effectivePadding=n,this.spriteGif.discardedFrames=[],this.spriteGif.previewFrameIndex=0,this.refreshSpriteFrameUsage(),this.spriteGif.gridPreviewUrl=this.buildSpriteGridPreview(i,t,e,n,new Set)}catch(i){this.spriteGif.frames=[],this.spriteGif.framePreviews=[],this.spriteGif.allFrames=[],this.spriteGif.allFramePreviews=[],this.spriteGif.frameCount=0,this.spriteGif.totalFrameCount=0,this.spriteGif.frameWidth=0,this.spriteGif.frameHeight=0,this.spriteGif.gridPreviewUrl="",this.spriteGif.previewFrameIndex=0,this.spriteGif.discardedFrames=[],this.spriteGif.effectivePadding=0,this.stopSpritePreviewTimer(),this.spriteGif.status=(i==null?void 0:i.message)||"精灵图解析失败",this.showToast((i==null?void 0:i.message)||"精灵图解析失败","error")}},buildSpriteGridPreview(t,e,i,r=0,s){const n=document.createElement("canvas");n.width=t.width,n.height=t.height;const a=n.getContext("2d");a.drawImage(t,0,0);const o=t.width/e,h=t.height/i,c=s instanceof Set?s:new Set;if(c.size){a.save(),a.fillStyle="rgba(239,68,68,0.18)",a.strokeStyle="rgba(239,68,68,0.65)",a.lineWidth=2;for(let l=0;l<i;l+=1)for(let u=0;u<e;u+=1){const d=l*e+u;if(!c.has(d))continue;const p=u*o,f=l*h;a.fillRect(p,f,o,h),a.strokeRect(Math.round(p)+.5,Math.round(f)+.5,Math.round(o),Math.round(h))}a.restore()}a.strokeStyle="rgba(37,99,235,0.75)",a.lineWidth=1;for(let l=1;l<e;l+=1){const u=Math.round(o*l)+.5;a.beginPath(),a.moveTo(u,0),a.lineTo(u,t.height),a.stroke()}for(let l=1;l<i;l+=1){const u=Math.round(h*l)+.5;a.beginPath(),a.moveTo(0,u),a.lineTo(t.width,u),a.stroke()}if(r>0){a.save(),a.strokeStyle="rgba(251,191,36,0.9)",a.setLineDash([6,4]),a.lineWidth=1;for(let l=0;l<i;l+=1)for(let u=0;u<e;u+=1){const d=u*o+r,p=l*h+r,f=o-r*2,m=h-r*2;f<=1||m<=1||a.strokeRect(Math.round(d)+.5,Math.round(p)+.5,Math.round(f),Math.round(m))}a.restore()}return n.toDataURL("image/png")},async rebuildSpriteGridPreview(){if(!this.spriteGif.imageUrl){this.spriteGif.gridPreviewUrl="";return}try{const t=await this.loadImageFromUrl(this.spriteGif.imageUrl),e=Math.max(1,Math.floor(Number(this.spriteGif.columns)||1)),i=Math.max(1,Math.floor(Number(this.spriteGif.rows)||1)),{effectivePadding:r}=this.computeSpriteGridMetrics(t.width,t.height,e,i,this.spriteGif.padding);this.spriteGif.effectivePadding=r,this.spriteGif.gridPreviewUrl=this.buildSpriteGridPreview(t,e,i,r,new Set(this.spriteGif.discardedFrames||[]))}catch(t){console.warn("无法更新网格预览",t)}},handleSpriteGridClick(t){var l;if(!this.spriteGif.gridPreviewUrl)return;const e=(l=this.$refs)==null?void 0:l.spriteGridImage;if(!e)return;const i=e.getBoundingClientRect();if(!i.width||!i.height)return;const r=t.clientX-i.left,s=t.clientY-i.top;if(r<0||s<0||r>i.width||s>i.height)return;const n=Math.max(1,Math.floor(Number(this.spriteGif.columns)||1)),a=Math.max(1,Math.floor(Number(this.spriteGif.rows)||1)),o=Math.min(n-1,Math.floor(r/i.width*n)),c=Math.min(a-1,Math.floor(s/i.height*a))*n+o;this.toggleSpriteFrameDiscard(c)},toggleSpriteFrameDiscard(t){const e=this.spriteGif.totalFrameCount||0;if(!Number.isInteger(t)||t<0||t>=e)return;const i=new Set(this.spriteGif.discardedFrames||[]);i.has(t)?i.delete(t):i.add(t),this.spriteGif.discardedFrames=Array.from(i).sort((r,s)=>r-s),this.refreshSpriteFrameUsage(),this.rebuildSpriteGridPreview()},startSpritePreviewTimer(){if(this.stopSpritePreviewTimer(),!this.spriteGif.previewPlaying||!this.spriteGif.framePreviews.length)return;const t=Math.max(1,Number(this.spriteGif.fps)||1),e=Math.max(30,Math.round(1e3/t));this.spritePreviewTimer=setInterval(()=>{this.spriteGif.framePreviews.length&&(this.spriteGif.previewFrameIndex=(this.spriteGif.previewFrameIndex+1)%this.spriteGif.framePreviews.length)},e)},stopSpritePreviewTimer(){this.spritePreviewTimer&&(clearInterval(this.spritePreviewTimer),this.spritePreviewTimer=null)},toggleSpritePreview(){this.spriteGif.framePreviews.length&&(this.spriteGif.previewPlaying=!this.spriteGif.previewPlaying,this.spriteGif.previewPlaying?this.startSpritePreviewTimer():this.stopSpritePreviewTimer())},async applySpriteEdits(){if(this.spriteGif.imageUrl)try{const t=await this.loadImageFromUrl(this.spriteGif.imageUrl),e=this.clampSpriteValue(Number(this.spriteGif.edit.cropX)||0,0,t.width-1),i=this.clampSpriteValue(Number(this.spriteGif.edit.cropY)||0,0,t.height-1),r=this.clampSpriteValue(Number(this.spriteGif.edit.cropWidth)||t.width,1,t.width-e),s=this.clampSpriteValue(Number(this.spriteGif.edit.cropHeight)||t.height,1,t.height-i),n=document.createElement("canvas");n.width=r,n.height=s;const a=n.getContext("2d");a.drawImage(t,e,i,r,s,0,0,r,s),this.spriteGif.edit.removeBg&&this.removeBackgroundFromCanvas(a,r,s,this.spriteGif.edit.bgColor,this.spriteGif.edit.bgTolerance);const o=(Math.round(Number(this.spriteGif.edit.rotation)/90)%4+4)%4;let h=n;if(o!==0){const l=document.createElement("canvas");l.width=o%2===0?n.width:n.height,l.height=o%2===0?n.height:n.width;const u=l.getContext("2d");u.translate(l.width/2,l.height/2),u.rotate(o*90*Math.PI/180),u.drawImage(n,-n.width/2,-n.height/2),h=l}const c=h.toDataURL("image/png");this.spriteGif.imageUrl=c,this.spriteGif.imageWidth=h.width,this.spriteGif.imageHeight=h.height,this.initializeSpriteEditBounds(h.width,h.height),await this.updateSpriteFrames(),this.showToast("已应用简单编辑","success")}catch(t){this.showToast((t==null?void 0:t.message)||"应用编辑失败","error")}},removeBackgroundFromCanvas(t,e,i,r,s){const n=t.getImageData(0,0,e,i),a=this.hexToRgb(r);if(!a)return;const o=n.data,h=Math.max(0,Math.min(100,Number(s)||0))*2.55;for(let c=0;c<o.length;c+=4)(Math.abs(o[c]-a.r)+Math.abs(o[c+1]-a.g)+Math.abs(o[c+2]-a.b))/3<=h&&(o[c+3]=0);t.putImageData(n,0,0)},hexToRgb(t){if(!t)return null;const e=t.replace("#","");if(![3,6].includes(e.length))return null;const i=e.length===3?e.split("").map(s=>s+s).join(""):e,r=parseInt(i,16);return{r:r>>16&255,g:r>>8&255,b:r&255}},resetSpriteEdits(){this.spriteGif.originalDataUrl&&(this.spriteGif.imageUrl=this.spriteGif.originalDataUrl,this.syncSpriteImageMeta(this.spriteGif.originalDataUrl),this.showToast("已还原原图","info"))},async ensureGifJs(){if(this.spriteGif.gifLibReady||q())return this.spriteGif.gifLibReady=!0,!0;k||(k=U(Zt,q,{timeout:15e3,attrs:{crossorigin:"anonymous"}}).catch(t=>{throw k=null,t}));try{return await k,this.spriteGif.gifLibReady=!0,!0}catch(t){return console.warn("GIF.js 加载失败",t),this.showToast("GIF 库加载失败，请稍后重试","error"),!1}},async generateSpriteGif(){var t;if(!this.spriteGif.frames.length){this.showToast("请先上传并分割精灵图","warning");return}this.spriteGif.isGenerating=!0;try{if(!await this.ensureGifJs())return;const i=window.GIF;if(!i){this.showToast("GIF 生成库未加载","error");return}const r=await this.resolveSpriteWorkerUrl(),s=Math.max(20,Math.round(1e3/Math.max(1,Number(this.spriteGif.fps)||1))),n=new i({workers:2,workerScript:r,width:this.spriteGif.frameWidth,height:this.spriteGif.frameHeight,quality:12,transparent:0});this.spriteGif.frames.forEach(h=>{n.addFrame(h,{delay:s,copy:!0})});const a=await new Promise((h,c)=>{n.on("finished",h),n.on("abort",()=>c(new Error("GIF 生成被取消"))),n.on("error",l=>c(l||new Error("GIF 生成失败"))),n.render()}),o=(((t=this.spriteGif.imageName)==null?void 0:t.replace(/\.[^.]+$/,""))||"sprite")+".gif";C(o,a),this.showToast("GIF 已生成","success")}catch(e){this.showToast((e==null?void 0:e.message)||"GIF 生成失败","error")}finally{this.spriteGif.isGenerating=!1}},async resolveSpriteWorkerUrl(){if(this.spriteGif.workerUrl)return this.spriteGif.workerUrl;if(typeof window>"u")return"./gif.worker.js";const t=window.location.href,e=["./gif.worker.js","./public/gif.worker.js"];for(let r=0;r<e.length;r+=1){const s=new URL(e[r],t).href;if(await this.checkWorkerExists(s))return this.spriteGif.workerUrl=s,s}const i=await this.fetchWorkerFromCdn();return i?(this.spriteGif.workerUrl=i,this.spriteGif.workerBlobUrl=i,i):new URL("./gif.worker.js",t).href},async checkWorkerExists(t){try{return(await fetch(t,{method:"HEAD",cache:"no-store"})).ok}catch{return!1}},async fetchWorkerFromCdn(){try{const t=await fetch("https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js");if(!t.ok)return null;const e=await t.text(),i=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(i)}catch{return null}},async ensurePaletteLib(){if(this.palette.libReady)return!0;if(this.palette.libLoading)return!1;this.palette.libLoading=!0,this.palette.status="正在加载调色盘库...";try{const t=await _t();return this.palette.libReady=t,this.palette.status=t?"请上传 PNG / JPG 图片":"调色盘库加载失败",t}catch{return this.palette.status="调色盘库加载失败",this.showToast("调色盘库加载失败","error"),!1}finally{this.palette.libLoading=!1}},triggerPaletteUpload(){var e;const t=(e=this.$refs)==null?void 0:e.paletteFileInput;t&&t.click()},async handlePaletteFileSelect(t){var r,s;const e=Array.from(t||[]);if(!e.length)return;const i=e[0];if(!((r=i.type)!=null&&r.startsWith("image/"))){this.showToast("仅支持 PNG / JPG 图片","warning");return}try{await this.loadPaletteImage(i)}catch(n){this.showToast((n==null?void 0:n.message)||"图片加载失败","error")}finally{(s=this.$refs)!=null&&s.paletteFileInput&&(this.$refs.paletteFileInput.value="")}},handlePaletteDrop(t){var e,i;this.palette.isDragging=!1,(i=(e=t.dataTransfer)==null?void 0:e.files)!=null&&i.length&&this.handlePaletteFileSelect(t.dataTransfer.files)},async loadPaletteImage(t){const e=await this.readFileAsDataUrl(t);this.palette.imageName=t.name,this.palette.originalDataUrl=e,this.palette.imageUrl=e;const i=await this.loadImageFromUrl(e);this.palette.imageWidth=i.width,this.palette.imageHeight=i.height,this.palette.status=`已加载：${i.width} × ${i.height}`,this.palette.colors=[],this.palette.rawPalette=[],this.palette.quantizedUrl="",this.palette.quantizedCanvas=null,this.showToast("图片已加载，点击「生成调色盘」开始处理","success")},async generatePaletteColors(){if(!this.palette.imageUrl){this.showToast("请先上传图片","warning");return}if(await this.ensurePaletteLib()){this.palette.isProcessing=!0,this.palette.status="正在生成调色盘...";try{const e=await this.loadImageFromUrl(this.palette.imageUrl),i=document.createElement("canvas");i.width=e.width,i.height=e.height,i.getContext("2d").drawImage(e,0,0);const{data:s}=st(i),n=Math.min(256,Math.max(2,this.palette.maxColors)),a=Ht(s,n,{format:this.palette.format});this.palette.rawPalette=a;let o=a;this.palette.sortMode==="luminance"?o=z(a):this.palette.sortMode==="hue"&&(o=J(a)),this.palette.colors=H(o);const h=Vt(i,a,this.palette.format);this.palette.quantizedCanvas=h,this.palette.quantizedUrl=h.toDataURL("image/png"),this.palette.status=`已生成 ${a.length} 色调色盘`,this.showToast(`已生成 ${a.length} 色调色盘`,"success")}catch(e){this.palette.status="生成失败："+((e==null?void 0:e.message)||"未知错误"),this.showToast((e==null?void 0:e.message)||"调色盘生成失败","error")}finally{this.palette.isProcessing=!1}}},resortPalette(){var e;if(!((e=this.palette.rawPalette)!=null&&e.length))return;let t=this.palette.rawPalette;this.palette.sortMode==="luminance"?t=z(this.palette.rawPalette):this.palette.sortMode==="hue"&&(t=J(this.palette.rawPalette)),this.palette.colors=H(t)},downloadQuantizedImage(){var e;if(!this.palette.quantizedUrl){this.showToast("请先生成调色盘","warning");return}const t=(((e=this.palette.imageName)==null?void 0:e.replace(/\.[^.]+$/,""))||"image")+`_${this.palette.colors.length}colors.png`;fetch(this.palette.quantizedUrl).then(i=>i.blob()).then(i=>C(t,i)).then(()=>this.showToast("图片已下载","success")).catch(i=>this.showToast("下载失败","error"))},copyPaletteAsCSS(){var i;if(!((i=this.palette.colors)!=null&&i.length)){this.showToast("请先生成调色盘","warning");return}const e=`:root {
${this.palette.colors.map((r,s)=>`  --color-${s}: ${r.hex};`).join(`
`)}
}`;this.copyValue(e)},copyPaletteAsJSON(){var e;if(!((e=this.palette.colors)!=null&&e.length)){this.showToast("请先生成调色盘","warning");return}const t=JSON.stringify(this.palette.colors.map(i=>i.hex),null,2);this.copyValue(t)},clearPalette(){this.palette.imageName="",this.palette.imageUrl="",this.palette.originalDataUrl="",this.palette.imageWidth=0,this.palette.imageHeight=0,this.palette.colors=[],this.palette.rawPalette=[],this.palette.quantizedUrl="",this.palette.quantizedCanvas=null,this.palette.status="请上传 PNG / JPG 图片"}},watch:{activeTab(t){t==="converter"&&this.prefetchConverters(),t==="spriteGif"&&this.ensureGifJs(),t==="palette"&&this.ensurePaletteLib()},"spriteGif.columns"(){this.updateSpriteFrames()},"spriteGif.rows"(){this.updateSpriteFrames()},"spriteGif.padding"(){this.updateSpriteFrames()},"spriteGif.fps"(){this.spriteGif.previewPlaying&&this.startSpritePreviewTimer()},"gifSprite.columns"(){this.rebuildGifSpriteSheet()},"gifSprite.padding"(){this.rebuildGifSpriteSheet()},"gifSprite.backgroundMode"(){this.rebuildGifSpriteSheet()},"gifSprite.backgroundColor"(){this.gifSprite.backgroundMode==="color"&&this.rebuildGifSpriteSheet()}},mounted(){this.runJoiner(),this.updateInjected(),this.updateTimestampFromDate(),this.updateDurationFromSeconds(),this.startTimestampTicker(),Kt()},beforeUnmount(){this.timestampTicker&&clearInterval(this.timestampTicker),this.stopSpritePreviewTimer(),this.stopGifSpritePreviewTimer(),this.spriteGif.workerBlobUrl&&URL.revokeObjectURL(this.spriteGif.workerBlobUrl)}});Qt.mount("#app");
